#!/bin/sh
BINDIR=$( readlink -f $(dirname $0) )

export CVSROOT=anoncvs@obsdacvs.cs.toronto.edu:/cvs

PKGPATH=$( make show=BASE_PKGPATH )
PKGNAME=$( make show=PKGNAME )
PORT=$( basename -- $PKGPATH )
VER=${PKGNAME:#$PORT-}

/usr/ports/infrastructure/bin/portcheck || exit

if [ -e CVS ]; then
	cvs diff | mail -s "[UPDATE] $PKGPATH to $VER" $USER
else
    tmpdir=$( mktemp -d -t mail_port_diff-XXXXXX )
    [ -n $tmpdir -a -d $tmpdir ] || exit 2

    DESCR=$( make show=DESCR )
    cd ${PWD%$PKGPATH}
    tar czf $tmpdir/$PKGNAME.tar.gz $PKGPATH
    cat $DESCR | $BINDIR/sendmime -s "[NEW] $PKGPATH $VER" \
        -f $tmpdir/$PKGNAME.tar.gz $USER

    rm -rf $tmpdir
fi
