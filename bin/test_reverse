#!/bin/sh

depends() {
	PKG=$( echo $1 | sed -e "s/'/''/g" )

	sqlite3 /usr/local/share/sqlports <<EOL
SELECT DISTINCT FULLPKGPATH FROM Depends 
 WHERE DEPENDSPATH = '$PKG';
EOL
}


CURDIR=$PWD
cd /usr/ports/databases/sqlports && PACKAGE=compact make install && cd $OLDPWD
DEPENDS=$( depends $( make show=BASE_PKGPATH ) | sed -e 's/,[^ ]+//g' )

doas pkg_delete -X /var/db/pkg/*-firmware-*
[ -n "$EXTRA_PACKAGES" ] && sudo pkg_add $EXTRA_PACKAGES

# First get all the packages installed.
rm -rf /usr/ports/pobj/*
for p in $DEPENDS; do cd /usr/ports/$p && make PLIST_DB= prepare; done

# Then actually get the results
rm -rf /usr/ports/pobj/*
for p in $DEPENDS; do cd /usr/ports/$p && make PLIST_DB= test; done 2>&1 | tee $CURDIR/reverse_depends_results
